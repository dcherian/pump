
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Simple model analysis &#8212; PUMP</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reduced Shear Evolution equation" href="shred2-evol.html" />
    <link rel="prev" title="TAO Ri analysis" href="tao-ri-analysis.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">PUMP</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  miχpods
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="mixpods.html">
   miχpods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixpods-tao.html">
   miχpods - TAO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixpods-les.html">
   miχpods for LES simulations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixpods-mom6.html">
   miχpods: MOM6
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  TIW Turbulence
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="TIW-DCL.html">
   TIW DCL
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dcl-paper.html">
   TIW DCL Paper Figures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ctd-adcp.html">
   TIW Cruise Sections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="TIW-compositing.html">
   TIW Compositing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="vertical-velocity.html">
   TIW vertical velocity in MITgcm simulations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tiw-floats.html">
   EM-APEX floats in TIWs
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Marginal Stability
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="bulk-Ri.html">
   Bulk Ri analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MI-extent.html">
   Extent of marginal stability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tao-ri-analysis.html">
   TAO Ri analysis
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Simple model analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="shred2-evol.html">
   Reduced Shear Evolution equation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  χpod/Chameleon
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="equix-divergence.html">
   EQUIX: Jq divergence
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="equix-examine.html">
   Chameleon heat flux χ vs ε
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixing-efficiency.html">
   Variations in
   <span class="math notranslate nohighlight">
    \(Ri_f\)
   </span>
   ,
   <span class="math notranslate nohighlight">
    \(Γ\)
   </span>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="les-examine.html">
   LES first look
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="long-term-turbulence.html">
   Long-term tubulence in 20-year simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="les-tendencies.html">
   LES tendencies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="heat-momentum-budget-checks.html">
   Heat and momentum budgets with MITgcm output
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="submeso-deep-100.html">
   Deep submesoscales in 1/100°?
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/dcherian/pump"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/mi-simple-model.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-data">
   Read data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#heat-flux">
   Heat flux
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ssh">
   SSH
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tao-wind">
   TAO wind
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numerator-terms">
   Numerator terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#denominator-terms">
   Denominator terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#medians-as-approx">
   Medians as approx.
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Simple model analysis</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-data">
   Read data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#heat-flux">
   Heat flux
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ssh">
   SSH
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tao-wind">
   TAO wind
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numerator-terms">
   Numerator terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#denominator-terms">
   Denominator terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#medians-as-approx">
   Medians as approx.
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="simple-model-analysis">
<h1>Simple model analysis<a class="headerlink" href="#simple-model-analysis" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%matplotlib inline
%load_ext autoreload

import dask
import matplotlib as mpl
import matplotlib.pyplot as plt
import numpy as np
import seawater as sw
import xarray as xr
import pop_tools
# %aimport xgcm

# import hvplot.xarray

import dcpy
import pump

mpl.rcParams[&#39;savefig.dpi&#39;] = 300
mpl.rcParams[&#39;savefig.bbox&#39;] = &#39;tight&#39;
mpl.rcParams[&#39;figure.dpi&#39;] = 140

xr.set_options(keep_attrs=True, display_style=&quot;html&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">d0b326038a8b</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">import</span> <span class="nn">seawater</span> <span class="k">as</span> <span class="nn">sw</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">pop_tools</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># %aimport xgcm</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> 

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pop_tools&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import distributed
import ncar_jobqueue

if &#39;client&#39; in locals():
    client.close(); cluster.close()

cluster = ncar_jobqueue.NCARCluster(
    cores=9, processes=4, memory=&#39;109GB&#39;,
    walltime=&#39;02:00:00&#39;, project=&#39;NCGD0043&#39;)

client = dask.distributed.Client(cluster)

cluster.adapt(minimum=4, maximum=24, wait_count=600)
cluster
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c99f72c622844e17ac2add337f2daa3d", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<section id="read-data">
<h2>Read data<a class="headerlink" href="#read-data" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def estimate_euc_depth_terms(ds):

    ds.load()

    surface = {&#39;depth&#39;: -20, &#39;method&#39;: &#39;nearest&#39;}

    ds[&#39;h&#39;] = (ds.eucmax - surface[&#39;depth&#39;])
    ds[&#39;h&#39;].attrs[&#39;long_name&#39;] = &#39;$h$&#39;

    if &#39;u&#39; in ds:
        ds[&#39;us&#39;] = ds.u.sel(**surface)
        ds[&#39;ueuc&#39;] = ds.u.interp(depth=ds.eucmax, longitude=ds.longitude, method=&#39;linear&#39;)
        ds[&#39;du&#39;] = ds.us - ds.ueuc
        ds.du.attrs[&#39;long_name&#39;] = &#39;$\Delta$u&#39;

    if &#39;dens&#39; in ds:
        ds[&#39;dens_euc&#39;] = ds.dens.interp(depth=ds.eucmax,
                                        longitude=ds.longitude,
                                        method=&#39;linear&#39;)
        ds[&#39;b&#39;] = ds.dens * -9.81/ds.dens_euc
        ds[&#39;bs&#39;] = ds.b.sel(**surface)
        ds[&#39;beuc&#39;] = -9.81 * xr.ones_like(ds.bs)

        ds[&#39;db&#39;] = ds.bs - ds.beuc
        ds.db.attrs[&#39;long_name&#39;] = &#39;$\Delta$b&#39;

    if &#39;db&#39; in ds and &#39;du&#39; in ds and &#39;h&#39; in ds:
        with xr.set_options(keep_attrs=False):
            ds[&#39;Ri&#39;] = ds.db * np.abs(ds.h) / (ds.du**2)

    return ds

if &#39;gcm1&#39; in locals():
    import airsea
    print(&#39;skipping gcm1, jra, ssh&#39;)
    subset = (gcm1.annual.sel(latitude=0, method=&#39;nearest&#39;)
              .assign_coords(latitude=0)
              .squeeze()
              .sel(depth=slice(0, -250)))
    subset[&#39;dens&#39;] = pump.mdjwf.dens(subset.salt, subset.theta, subset.depth)
    subset[&#39;eucmax&#39;] = pump.calc.get_euc_max(subset.u)

    subset = estimate_euc_depth_terms(subset)
    subset.attrs[&#39;name&#39;] = &#39;gcm 1m 1996 mean&#39;

    jra = (pump.obs.read_jra()
           .sel(latitude=0, method=&#39;nearest&#39;)
           .sel(time=&#39;1996&#39;)
           .load())
    jra[&#39;tau&#39;] = jra.Uwind.copy(
        data=airsea.windstress.stress(np.hypot(jra.Uwind, jra.Vwind)))

    mean_jra = jra.mean(&#39;time&#39;)
    ssh = xr.open_mfdataset(pump.obs.root + &#39;make_TPOS_MITgcm/1996/SSH*.nc&#39;).zos

johnson = (pump.obs.read_johnson()
           .sel(latitude=0))
johnson[&#39;eucmax&#39;] = pump.get_euc_max(johnson.u)
johnson = estimate_euc_depth_terms(johnson)
johnson.attrs[&#39;name&#39;] = &#39;Johnson&#39;

# need to fill to the surface
tao_adcp = pump.obs.read_tao_adcp().mean(&#39;time&#39;).bfill(&#39;depth&#39;)
tao_adcp[&#39;eucmax&#39;] = pump.get_euc_max(tao_adcp.u)

tao_ctd = (pump.obs.read_tao()
           .sel(latitude=0, longitude=tao_adcp.longitude)
           .drop([&#39;u&#39;, &#39;v&#39;])
           .mean(&#39;time&#39;)
           .compute())
tao_ctd[&#39;eucmax&#39;] = tao_adcp.eucmax
tao_ctd[&#39;dens&#39;] = pump.mdjwf.dens(np.array(35.0), tao_ctd.temp, tao_ctd.depth)
tao_ctd_raw = tao_ctd.copy(deep=True)
tao_ctd = (tao_ctd
           .sortby(&#39;depth&#39;)
           .interpolate_na(&#39;depth&#39;)
           .sortby(&#39;depth&#39;, ascending=False)
           .bfill(&#39;depth&#39;))

tao = xr.merge([estimate_euc_depth_terms(tao_adcp)[[&#39;us&#39;, &#39;ueuc&#39;, &#39;du&#39;, &#39;eucmax&#39;]],
                estimate_euc_depth_terms(tao_ctd)[[&#39;bs&#39;, &#39;beuc&#39;, &#39;db&#39;]]])
tao = estimate_euc_depth_terms(tao)
tao.attrs[&#39;name&#39;] = &#39;TAO&#39;

hires = xr.load_dataset(&#39;~/pump/glade/small-eq-mean.nc&#39;).sel(longitude=slice(-221, None))
hires[&#39;eucmax&#39;] = (pump.calc.get_euc_max(hires.u)
                   .rolling(longitude=200, center=True, min_periods=1)
                   .mean())
hires = estimate_euc_depth_terms(hires)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/glade/u/home/dcherian/pump/pump/obs.py:170: FutureWarning: In xarray version 0.15 the default behaviour of `open_mfdataset`
will change. To retain the existing behavior, pass
combine=&#39;nested&#39;. To use future default behavior, pass
combine=&#39;by_coords&#39;. See
http://xarray.pydata.org/en/stable/combining.html#combining-multi

  chunks={&quot;lat&quot;: 1, &quot;lon&quot;: 1, &quot;depth&quot;: 5},
/gpfs/u/home/dcherian/python/xarray/xarray/backends/api.py:933: FutureWarning: The datasets supplied have global dimension coordinates. You may want
to use the new `combine_by_coords` function (or the
`combine=&#39;by_coords&#39;` option to `open_mfdataset`) to order the datasets
before concatenation. Alternatively, to continue concatenating based
on the order the datasets are supplied in future, please use the new
`combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset).The datasets supplied require both concatenation and merging. From
xarray version 0.15 this will operation will require either using the
new `combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset), with a nested list structure such that you can combine
along the dimensions None. Alternatively if your datasets have global
dimension coordinates then you can use the new `combine_by_coords`
function.
  from_openmfds=True,
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 15
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 10
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 10
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 10
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/dask/array/core.py:3864: PerformanceWarning: Increasing number of chunks by factor of 11
  **blockwise_kwargs
</pre></div>
</div>
</div>
</div>
</section>
<section id="heat-flux">
<h2>Heat flux<a class="headerlink" href="#heat-flux" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>qnet = (xr.open_dataset(&#39;../glade/obs/tao/qnet_xyt_dy.cdf&#39;).rename({
    &#39;QT_210&#39;: &#39;qnet&#39;,
    &#39;lat&#39;: &#39;latitude&#39;,
    &#39;lon&#39;: &#39;longitude&#39;
})[&#39;qnet&#39;])
qnet[&#39;longitude&#39;] -= 360
qnet = qnet.where(np.abs(qnet) &lt; 1e5)
qnet
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;qnet&#39; (time: 6469, depth: 1, latitude: 11, longitude: 8)&gt;
array([[[[      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
           92.55531]]],


       [[[      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
          123.92926],
         [      nan,       nan,       nan, ...,       nan,       nan,
          167.82068]]],


       [[[      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
          144.79332],
         [      nan,       nan,       nan, ...,       nan,       nan,
          143.83264]]],


       ...,


       [[[      nan, 127.62819,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan]]],


       [[[      nan, 134.15   ,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan]]],


       [[[      nan,  33.85962,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         ...,
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan],
         [      nan,       nan,       nan, ...,       nan,       nan,
                nan]]]], dtype=float32)
Coordinates:
  * time       (time) datetime64[ns] 2000-04-22T12:00:00 ... 2018-01-06T12:00:00
  * depth      (depth) float32 0.0
  * latitude   (latitude) float32 -8.0 -5.0 -2.0 0.0 2.0 ... 8.0 9.0 10.0 12.0
  * longitude  (longitude) float32 -195.0 -180.0 -170.0 ... -125.0 -110.0 -95.0
Attributes:
    name:            QT
    long_name:       TOTAL HEAT FLUX
    generic_name:    qtot
    FORTRAN_format:   
    units:           W/M**2
    epic_code:       210
</pre></div>
</div>
</div>
</div>
</section>
<section id="ssh">
<h2>SSH<a class="headerlink" href="#ssh" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ssh = (xr.open_mfdataset([pump.obs.root + &#39;obs/aviso/zos_AVISO_L4_199210-201012.nc&#39;])
      .zos
      .rename({&#39;lat&#39;: &#39;latitude&#39;, &#39;lon&#39;: &#39;longitude&#39;}))
ssh[&#39;longitude&#39;] -= 360
ssh = ssh.sel(longitude=slice(-200, -80), latitude=slice(-25, 25)).mean(&#39;time&#39;).compute()
ssh
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/ipykernel_launcher.py:1: FutureWarning: In xarray version 0.13 the default behaviour of `open_mfdataset`
will change. To retain the existing behavior, pass
combine=&#39;nested&#39;. To use future default behavior, pass
combine=&#39;by_coords&#39;. See
http://xarray.pydata.org/en/stable/combining.html#combining-multi

  &quot;&quot;&quot;Entry point for launching an IPython kernel.
/gpfs/u/home/dcherian/python/xarray/xarray/backends/api.py:931: FutureWarning: The datasets supplied have global dimension coordinates. You may want
to use the new `combine_by_coords` function (or the
`combine=&#39;by_coords&#39;` option to `open_mfdataset`) to order the datasets
before concatenation. Alternatively, to continue concatenating based
on the order the datasets are supplied in future, please use the new
`combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset).
  from_openmfds=True,
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;zos&#39; (latitude: 50, longitude: 120)&gt;
array([[1.0146531 , 1.0037938 , 0.99376035, ..., 0.63221073, 0.61761034,
        0.6016931 ],
       [1.0273066 , 1.0175812 , 1.0088582 , ..., 0.62273055, 0.6081634 ,
        0.5922261 ],
       [1.046003  , 1.0380611 , 1.0309224 , ..., 0.61169213, 0.597813  ,
        0.5830368 ],
       ...,
       [1.3097773 , 1.3013064 , 1.2935021 , ..., 0.6009446 , 0.6040544 ,
        0.60238636],
       [1.2980543 , 1.2906426 , 1.2837585 , ..., 0.5306964 , 0.53614575,
        0.5542671 ],
       [1.2794156 , 1.2714981 , 1.263941  , ..., 0.43182534, 0.45010972,
        0.49250126]], dtype=float32)
Coordinates:
  * latitude   (latitude) float64 -24.5 -23.5 -22.5 -21.5 ... 22.5 23.5 24.5
  * longitude  (longitude) float64 -199.5 -198.5 -197.5 ... -82.5 -81.5 -80.5
Attributes:
    standard_name:     sea_surface_height_above_geoid
    long_name:         Sea Surface Height Above Geoid
    units:             m
    original_name:     maps_of_absolute_dynamic_topography
    history:           2011-02-11, 12:02:38, AVISO, Aviso2Cmor 2009-01-01 200...
    original_units:    cm
    cell_methods:      time: mean
    cell_measures:     area: areacello
    associated_files:  baseURL: http://cmip-pcmdi.llnl.gov/CMIP5/dataLocation...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(ssh).plot(robust=True, cmap=mpl.cm.Spectral_r)
plt.gcf().set_size_inches((8, 3))
plt.gca().set_title(&#39;SSH&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;SSH&#39;)
</pre></div>
</div>
<img alt="_images/mi-simple-model_9_1.png" src="_images/mi-simple-model_9_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(ssh.differentiate(&#39;longitude&#39;)/110e3).plot(robust=True)
plt.gcf().set_size_inches((8, 3))
plt.gca().set_title(&#39;$∂/∂_x$ SSH&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;$∂/∂_x$ SSH&#39;)
</pre></div>
</div>
<img alt="_images/mi-simple-model_10_1.png" src="_images/mi-simple-model_10_1.png" />
</div>
</div>
</section>
<section id="tao-wind">
<h2>TAO wind<a class="headerlink" href="#tao-wind" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tau = (xr.open_mfdataset(&#39;../glade/obs/tao/tau[x-y]_*_dy.cdf&#39;)
      .rename({&#39;TX_442&#39;: &#39;taux&#39;,
               &#39;TY_443&#39;: &#39;tauy&#39;,
               &#39;lat&#39;: &#39;latitude&#39;,
               &#39;lon&#39;: &#39;longitude&#39;}))
tau[&#39;longitude&#39;] -= 360
tau = tau.where((tau.taux &lt; 5) &amp; (tau.tauy &lt; 5))

tao = xr.merge([
    tao,
    tau.mean(&#39;time&#39;).sel(
        latitude=0, longitude=tao.longitude).squeeze().drop(&#39;depth&#39;).load()[[&#39;taux&#39;, &#39;tauy&#39;]],
    qnet.sel(latitude=0)
    .reindex(longitude=tao.longitude)
    .squeeze().drop(&#39;depth&#39;)
    .mean(&#39;time&#39;)
])
tao[&#39;tau&#39;] = np.hypot(tao.taux, tao.tauy)
tao = tao.squeeze()
tao
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/ipykernel_launcher.py:1: FutureWarning: In xarray version 0.13 the default behaviour of `open_mfdataset`
will change. To retain the existing behavior, pass
combine=&#39;nested&#39;. To use future default behavior, pass
combine=&#39;by_coords&#39;. See
http://xarray.pydata.org/en/stable/combining.html#combining-multi

  &quot;&quot;&quot;Entry point for launching an IPython kernel.
/gpfs/u/home/dcherian/python/xarray/xarray/backends/api.py:931: FutureWarning: The datasets supplied have global dimension coordinates. You may want
to use the new `combine_by_coords` function (or the
`combine=&#39;by_coords&#39;` option to `open_mfdataset`) to order the datasets
before concatenation. Alternatively, to continue concatenating based
on the order the datasets are supplied in future, please use the new
`combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset).The datasets supplied require both concatenation and merging. From
xarray version 0.13 this will operation will require either using the
new `combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset), with a nested list structure such that you can combine
along the dimensions None. Alternatively if your datasets have global
dimension coordinates then you can use the new `combine_by_coords`
function.
  from_openmfds=True,
/gpfs/u/home/dcherian/python/xarray/xarray/core/nanops.py:157: RuntimeWarning: Mean of empty slice
  return np.nanmean(a, axis=axis, dtype=dtype)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:    (longitude: 6)
Coordinates:
    latitude   float64 0.0
  * longitude  (longitude) float64 -213.0 -204.0 -195.0 -170.0 -140.0 -110.0
Data variables:
    us         (longitude) float32 -0.06934669 0.08536129 ... 0.011650631
    ueuc       (longitude) float64 0.3355 0.4491 0.4932 0.6898 1.049 0.965
    du         (longitude) float64 -0.4049 -0.3638 -0.4965 ... -1.149 -0.9534
    eucmax     (longitude) float32 -225.0 -200.0 -195.0 -155.0 -105.0 -75.0
    bs         (longitude) float64 -9.783 -9.783 -9.785 -9.795 -9.799 -9.8
    beuc       (longitude) float64 -9.81 -9.81 -9.81 -9.81 -9.81 -9.81
    db         (longitude) float64 0.0273 0.02699 0.02499 ... 0.01052 0.009748
    h          (longitude) float32 -205.0 -180.0 -175.0 -135.0 -85.0 -55.0
    Ri         (longitude) float64 34.14 36.72 17.75 2.764 0.6773 0.5898
    taux       (longitude) float32 -0.0027862845 -0.005322009 ... -0.028835593
    tauy       (longitude) float32 -0.0014525932 0.0005883495 ... 0.021475606
    qnet       (longitude) float32 nan nan 61.240654 ... 137.68852 163.67712
    tau        (longitude) float32 0.003142198 0.005354431 ... 0.03595404
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tau.mean(&#39;time&#39;).taux.plot(edgecolor=&#39;w&#39;)
plt.gcf().set_size_inches((8, 2))
plt.gca().set_title(&#39;Time averaged TAO wind stress&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Time averaged TAO wind stress&#39;)
</pre></div>
</div>
<img alt="_images/mi-simple-model_13_1.png" src="_images/mi-simple-model_13_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster.scale(24)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># 37 seconds

%%time 
ds0 = xr.open_mfdataset(&quot;/glade/p/cesm/community/ASD-HIGH-RES-CESM1/hybrid_v5_rel04_BC5_ne120_t12_pop62/ocn/proc/tseries/monthly/*UVEL*.nc&quot;, parallel=True, concat_dim=&quot;time&quot;, combine=&#39;nested&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/ipykernel_launcher.py:1: FutureWarning: In xarray version 0.13 the default behaviour of `open_mfdataset`
will change. To retain the existing behavior, pass
combine=&#39;nested&#39;. To use future default behavior, pass
combine=&#39;by_coords&#39;. See
http://xarray.pydata.org/en/stable/combining.html#combining-multi

  &quot;&quot;&quot;Entry point for launching an IPython kernel.
/gpfs/u/home/dcherian/python/xarray/xarray/backends/api.py:931: FutureWarning: The datasets supplied have global dimension coordinates. You may want
to use the new `combine_by_coords` function (or the
`combine=&#39;by_coords&#39;` option to `open_mfdataset`) to order the datasets
before concatenation. Alternatively, to continue concatenating based
on the order the datasets are supplied in future, please use the new
`combine_nested` function (or the `combine=&#39;nested&#39;` option to
open_mfdataset).
  from_openmfds=True,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 23.5 s, sys: 5.44 s, total: 28.9 s
Wall time: 34 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:             (d2: 2, nlat: 2400, nlon: 3600, time: 504, z_t: 62, z_t_150m: 15, z_w: 62, z_w_bot: 62, z_w_top: 62)
Coordinates:
  * z_t_150m            (z_t_150m) float32 500.0 1500.0 ... 13500.0 14500.0
  * z_t                 (z_t) float32 500.0 1500.0 ... 562499.06 587499.06
  * z_w                 (z_w) float32 0.0 1000.0 2000.0 ... 549999.06 574999.06
  * z_w_bot             (z_w_bot) float32 1000.0 2000.0 ... 574999.06 599999.06
  * z_w_top             (z_w_top) float32 0.0 1000.0 ... 549999.06 574999.06
  * time                (time) object 0045-02-01 00:00:00 ... 0087-01-01 00:00:00
    ULONG               (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    ULAT                (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    TLONG               (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    TLAT                (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
Dimensions without coordinates: d2, nlat, nlon
Data variables:
    time_bound          (time, d2) object dask.array&lt;chunksize=(12, 2), meta=np.ndarray&gt;
    dz                  (time, z_t) float32 dask.array&lt;chunksize=(12, 62), meta=np.ndarray&gt;
    dzw                 (time, z_w) float32 dask.array&lt;chunksize=(12, 62), meta=np.ndarray&gt;
    KMT                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    KMU                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    REGION_MASK         (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    UAREA               (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    TAREA               (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HU                  (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HT                  (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    DXU                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    DYU                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    DXT                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    DYT                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HTN                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HTE                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HUS                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    HUW                 (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    ANGLE               (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    ANGLET              (time, nlat, nlon) float64 dask.array&lt;chunksize=(12, 2400, 3600), meta=np.ndarray&gt;
    days_in_norm_year   (time) timedelta64[ns] 00:00:00 00:00:00 ... 00:00:00
    grav                (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    omega               (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    radius              (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    cp_sw               (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    sound               (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    vonkar              (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    cp_air              (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    rho_air             (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    rho_sw              (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    rho_fw              (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    stefan_boltzmann    (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    latent_heat_vapor   (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    latent_heat_fusion  (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    ocn_ref_salinity    (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    sea_ice_salinity    (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    T0_Kelvin           (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    salt_to_ppt         (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    ppt_to_salt         (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    mass_to_Sv          (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    heat_to_PW          (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    salt_to_Svppt       (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    salt_to_mmday       (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    momentum_factor     (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    hflux_factor        (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    fwflux_factor       (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    salinity_factor     (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    sflux_factor        (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    nsurface_t          (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    nsurface_u          (time) float64 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0
    UVEL                (time, z_t, nlat, nlon) float32 dask.array&lt;chunksize=(12, 62, 2400, 3600), meta=np.ndarray&gt;
Attributes:
    title:         hybrid_v5_rel04_BC5_ne120_t12_pop62
    history:       none
    Conventions:   CF-1.0; http://www.cgd.ucar.edu/cms/eaton/netcdf/CF-curren...
    contents:      Diagnostic and Prognostic Variables
    source:        CCSM POP2, the CCSM Ocean Component
    revision:      $Id: tavg.F90 41939 2012-11-14 16:37:23Z mlevy@ucar.edu $
    calendar:      All years have exactly  365 days.
    start_time:    This dataset was created on 2013-03-05 at 14:49:04.8
    cell_methods:  cell_methods = time: mean ==&gt; the variable values are aver...
    nsteps_total:  12821677
    tavg_sum:      2678400.000001031
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time 
ds = xr.open_mfdataset(&quot;/glade/p/cesm/community/ASD-HIGH-RES-CESM1/hybrid_v5_rel04_BC5_ne120_t12_pop62/ocn/proc/tseries/monthly/*.nc&quot;, 
                       parallel=True, concat_dim=&#39;time&#39;, coords=&quot;minimal&quot;, data_vars=&quot;minimal&quot;, compat=&#39;override&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/glade/u/home/dcherian/miniconda3/envs/dcpy/lib/python3.6/site-packages/ipykernel_launcher.py:2: FutureWarning: In xarray version 0.13 the default behaviour of `open_mfdataset`
will change. To retain the existing behavior, pass
combine=&#39;nested&#39;. To use future default behavior, pass
combine=&#39;by_coords&#39;. See
http://xarray.pydata.org/en/stable/combining.html#combining-multi

  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 19 s, sys: 504 ms, total: 19.5 s
Wall time: 23 s
</pre></div>
</div>
</div>
</div>
<p>\begin{align}
Ri &amp;= \frac{2 \bar{w} h Q}{\left(b_{euc}hη_x + Δb/2 h h_x + τ_w \right)²} \
\frac{Ri}{\bar{w}} &amp;= \frac{10^2 10^{-8}}{\left(10×10^2×10^{-8} + 10^{-2} × 10^2 × 10^{-5} + 10^{-5}\right)²} = \frac{10^{-6}}{10^{-10}} = 10^{-4}
\end{align}</p>
<p><em>Assumptions:</em></p>
<ol class="simple">
<li><p>Linear <span class="math notranslate nohighlight">\(w\)</span> which is 0 at EUCmax: <span class="math notranslate nohighlight">\(w = \bar{w} (1+z/h)\)</span> This is diathermal <span class="math notranslate nohighlight">\(w\)</span> since this form says that <span class="math notranslate nohighlight">\(w=0\)</span> at <span class="math notranslate nohighlight">\(z=-h\)</span> i.e. <span class="math notranslate nohighlight">\(\bar{w}\)</span> is diathermal velocity at the top of the layer</p></li>
<li><p>Linear <span class="math notranslate nohighlight">\(u\)</span> between EUCmax and surface</p></li>
</ol>
<p><em>Choices:</em></p>
<ol class="simple">
<li><p>Fill TAO qnet using linear interpolation.</p></li>
<li><p>Running mean SSH over 20 points (20°) in longitude, then calculate gradient <span class="math notranslate nohighlight">\(η_x\)</span></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>xr.set_options(keep_attrs=False)

# interpolate to SSH longitudes
ds = tao.interp(longitude=ssh.longitude)
# Fill qnet using linear interpolation
ds[&#39;qnet&#39;] = (tao.qnet.dropna(&#39;longitude&#39;)
              .interp(longitude=ssh.longitude, kwargs={&#39;fill_value&#39;: &quot;extrapolate&quot;}))

db = ds.db
beuc = -9.81  # b = -gρ/ρ_{euc}
Q = ds.qnet * 9.81 * 2e-4 / (1025 * 4200)  # g α Q / (ρ c_p): heat flux in W/m² → m²/s³
h = np.abs(ds.eucmax)  # derivation integrates from z=-h to z=η, so h is positive
hx = h.differentiate(&#39;longitude&#39;)/110e3
sshx = (ssh.sel(latitude=0, method=&#39;nearest&#39;)
        .rolling(longitude=20, center=True, min_periods=5)
        .mean()
        .differentiate(&#39;longitude&#39;))/110e3

num = 2 * h *  Q
den = (beuc * h * sshx + db/2 * h * hx + ds.tau/1025)**2

Riow = num / den
Riow.attrs[&#39;long_name&#39;] = &#39;$Ri/w$&#39;
Riow.attrs[&#39;units&#39;] = &#39;s/m&#39;

num.attrs[&#39;units&#39;] = &#39;m³/s³&#39;
den.attrs[&#39;units&#39;] = &#39;m⁴/s⁴&#39;


f, ax = plt.subplots(3, 1, sharex=True, sharey=False, constrained_layout=True)
Riow.plot(ax=ax[0], yscale=&#39;log&#39;, ylim=[1e2, 1e6], xlim=[-225, -95], label=&#39;Simple model&#39;, _labels=False)
(10**3 * tao.Ri).plot(ax=ax[0], label=&#39;$Ri_b^{tao}/10^{-3}$&#39;, _labels=False)
(10**3 * johnson.Ri).plot(ax=ax[0], label=&#39;$Ri_b^{johnson}/10^{-3}$&#39;, _labels=False)
ax[0].legend(loc=&#39;upper right&#39;)
ax[0].set_ylabel(&#39;Ri/w [s/m]&#39;)
num.plot(ax=ax[1], _labels=False)
den.plot(ax=ax[2], _labels=False)

ax[0].set_yticks([1e2, 1e3, 1e4, 1e5, 1e6])
ax[0].grid(True)

ax[1].set_title(&#39;numerator = $2 h Q$&#39;)
ax[2].set_title(&#39;denominator = $(-ghη_x + Δb/2 h h_x + τ/ρ_0)²$&#39;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;denominator = $(-ghη_x + Δb/2 h h_x + τ/ρ_0)²$&#39;)
</pre></div>
</div>
<img alt="_images/mi-simple-model_18_1.png" src="_images/mi-simple-model_18_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster.scale(0)
</pre></div>
</div>
</div>
</div>
</section>
<section id="numerator-terms">
<h2>Numerator terms<a class="headerlink" href="#numerator-terms" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>h.plot(label=&#39;eucmax&#39;)
ds.qnet.plot(label=&#39;qnet&#39;)
plt.gca().legend()
plt.gca().set_ylabel(&#39;&#39;)
plt.gcf().set_size_inches((8, 3))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/mi-simple-model_21_0.png" src="_images/mi-simple-model_21_0.png" />
</div>
</div>
</section>
<section id="denominator-terms">
<h2>Denominator terms<a class="headerlink" href="#denominator-terms" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># den = (beuc * h * sshx + db/2 * h * hx + ds.tau/1025)**2

(beuc * h * sshx).plot(label=&#39;$-gh η_x$&#39;)
(ds.tau/1025).plot(label=&#39;$τ/ρ_0$&#39;)
(ds.db/2 * h * hx).plot(label=&#39;$Δb/2 hh_x$&#39;, ylim=[-1.5e-4, 1.5e-4])
(beuc * h * sshx + db/2 * h * hx + ds.tau/1025).plot(label=&#39;denom&#39;, color=&#39;k&#39;)
plt.gca().legend()
dcpy.plots.liney(0)
plt.gcf().set_size_inches((8, 3))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/mi-simple-model_23_0.png" src="_images/mi-simple-model_23_0.png" />
</div>
</div>
</section>
<section id="medians-as-approx">
<h2>Medians as approx.<a class="headerlink" href="#medians-as-approx" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(f&quot;η_x = {sshx.median().values:.1e}&quot;)
print(f&quot;h_x = {hx.median().values:.1e}&quot;)
print(f&quot;Δb/2 = {ds.db.median().values/2:.1e}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>η_x = -4.3e-08
h_x = -1.5e-05
Δb/2 = 6.4e-03
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="tao-ri-analysis.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">TAO Ri analysis</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="shred2-evol.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reduced Shear Evolution equation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Deepak Cherian<br/>
  
      &copy; Copyright 2022.<br/>
    <div class="extra_footer">
      <div>
<script data-goatcounter="https://count.cherian.net/count"
        async src="count.js"></script>
</div>

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>